# AI City Builder - プロジェクト概要

## コンセプト

AI City Builder は、**自然言語だけで街づくりをする**新しいタイプのシティビルダーゲームです。従来のツールバーやボタン操作を完全に排除し、プレイヤーは AI 市長とチャットや音声で会話しながら都市を建設・管理します。

市民が都市の問題を検知してリクエストを発信し、プレイヤーが会話を通じてそれを解決していくゲーム性を備えています。

## 主な特徴

### 会話型シティビルディング
- チャットまたは音声で AI 市長に指示を出して建物を配置
- 「住宅を3軒建てて」「道路を東西に通して」などの自然言語コマンド
- AI が Function Calling で都市状態を確認し、適切な場所に建設

### 市民リクエストシステム
- 市民が都市の問題（住宅不足、失業、停電など）を自動検出
- リクエストとして AI 市長に通知 → プレイヤーに解決を促す
- リクエスト達成で幸福度が上昇するゲームループ

### AI 音声対話
- **市長の声**: Gemini Live API によるリアルタイム音声対話（マイク入力対応）
- **市民の声**: Gemini Live API によるテキスト読み上げ
- 音声の重なりを防ぐスピーチコーディネーター機能
- 市民リクエスト発生時、市長が紹介 → 市民が要望を話す

### 3D シティビジュアライゼーション
- Three.js による 3D 都市表示
- 建物の建設・レベルアップアニメーション
- 市民の移動、車両の走行シミュレーション
- 建物クリックで市民との個別会話

## 技術スタック

| カテゴリ | 技術 |
|---------|------|
| 3D レンダリング | Three.js v0.155 |
| AI | Google Gemini API（gemini-3-flash-preview / gemini-2.5-flash-native-audio） |
| 音声 | Gemini Live API（WebSocket リアルタイム音声） |
| フロントエンド | TypeScript, Tailwind CSS v4 |
| ビルドツール | Vite 6 |
| API ブリッジ | Vite HMR WebSocket + HTTP API（curl/Claude Code 連携） |

## アーキテクチャ

```
┌──────────────────────────────────────────────────────────────┐
│  ブラウザ                                                      │
│  ┌─────────────────────────┬──────────────────────────┐       │
│  │  3D ゲームビュー (70%)    │  AI チャットパネル (30%)    │       │
│  │  - Three.js キャンバス    │  - メッセージ履歴          │       │
│  │  - ステータスバー          │  - クイックアクション       │       │
│  │    (人口/幸福度/要望数)    │  - テキスト/音声入力       │       │
│  └─────────────────────────┴──────────────────────────┘       │
│                                                                │
│  ┌──────────────────────────────────────────────────────┐     │
│  │  AI システム                                          │     │
│  │  ├── GeminiService (テキストチャット + Function Calling) │     │
│  │  ├── VoiceSession (市長の音声対話)                      │     │
│  │  ├── CitizenVoice (市民の音声読み上げ)                   │     │
│  │  ├── RequestEngine (市民リクエスト生成・充足判定)          │     │
│  │  ├── Advisor (プロアクティブな提案)                      │     │
│  │  └── SpeechCoordinator (音声の排他制御)                  │     │
│  └──────────────────────────────────────────────────────┘     │
│                                                                │
│  ┌──────────────────────────────────────────────────────┐     │
│  │  シミュレーション                                       │     │
│  │  ├── City (8x8 グリッド, 幸福度計算)                     │     │
│  │  ├── Buildings (住宅/商業/工業/道路/発電所/送電線)         │     │
│  │  ├── Citizens (人口シミュレーション, 就職, 通勤)           │     │
│  │  ├── Vehicles (車両移動, 道路ネットワーク経路探索)         │     │
│  │  └── Power Service (電力供給ネットワーク)                 │     │
│  └──────────────────────────────────────────────────────┘     │
└──────────────────────────────────────────────────────────────┘
         ↕ HMR WebSocket
┌──────────────────────────────────────────────────────────────┐
│  Vite Dev Server                                              │
│  └── HTTP API (/api/*) ← curl / Claude Code からの操作        │
└──────────────────────────────────────────────────────────────┘
```

## ゲームシステム

### 建物タイプ
| タイプ | 説明 |
|--------|------|
| residential | 住宅 - 市民が住む |
| commercial | 商業施設 - 雇用を提供 |
| industrial | 工場 - 雇用を提供 |
| road | 道路 - 建物の道路アクセスに必要 |
| power-plant | 発電所 - 電力を生成 |
| power-line | 送電線 - 電力を配送 |

### 幸福度システム（0〜100）
- 基礎値: 50
- 雇用率: 最大 +30
- 電力供給率: 最大 +10
- 人口ボーナス: +10
- 未解決リクエスト: -5 / 件（最大 -25）

### 市民リクエストタイプ
| タイプ | 発生条件 |
|--------|---------|
| housing | 人口が住宅容量の 80% を超過 |
| jobs | 失業者がいて商業/工業施設が不足 |
| power | 電力未供給の建物が存在 |
| road | 道路アクセスのない建物が存在 |
| commerce | 商業施設が住宅数の 30% 未満 |

## セットアップ

```bash
# 依存関係のインストール
npm install

# .env ファイルに Gemini API キーを設定
echo "VITE_GEMINI_API_KEY=your_api_key_here" > .env

# 開発サーバー起動
npm run dev
# → http://127.0.0.1:3000/
```

## ファイル構成

```
src/
├── index.html                    # メインHTML
├── public/main.css               # スタイル（Tailwind CSS）
└── scripts/
    ├── game.js                   # Three.js ゲームマネージャー
    ├── ui.js                     # ステータスバー・情報パネル
    ├── camera.js                 # カメラ制御
    ├── input.js                  # マウス/キーボード入力
    ├── config.js                 # ゲーム設定
    ├── api-bridge.ts             # HMR API ブリッジ
    ├── ai/
    │   ├── index.ts              # AI システム初期化
    │   ├── gemini-service.ts     # Gemini API ラッパー
    │   ├── chat-panel.ts         # チャット UI
    │   ├── city-api.ts           # 都市操作 API
    │   ├── advisor.ts            # AI アドバイザー
    │   ├── citizen-chat.ts       # 市民チャットダイアログ
    │   ├── citizen-voice.ts      # 市民/市長音声（Gemini Live API）
    │   ├── voice-session.ts      # 音声対話セッション
    │   ├── speech-coordinator.ts # 音声排他制御
    │   ├── request-engine.ts     # 市民リクエストエンジン
    │   └── demo-presets.ts       # デモ用レイアウト
    └── sim/
        ├── city.js               # 都市シミュレーション
        ├── tile.js               # グリッドタイル
        ├── citizen.js            # 市民 AI
        ├── buildings/            # 建物クラス群
        ├── vehicles/             # 車両・経路探索
        └── services/             # 電力サービス等
```
